<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <meta content="" name="description">
    <meta content="" name="author">
    <title>Pilas Bloques Registro</title>

    <link rel="stylesheet" type="text/css" href="staticos/assets/css/login.css">

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript">

      let errores = "Error: los siguientes campos son invalidos:\n" // belleza
      function areErrorsPresent(email, username, password, password2) {
        const regexForValidateEmail = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        const isEmailValid = email && regexForValidateEmail.test(email)
        !isEmailValid && (errores += "- Email (Incompleto o formato incorrecto) \n");
        const isUsernameValid = username
        !isUsernameValid && (errores += "- Nombre de usuario: incompleto\n");
        const isPasswordValid = password && password.length >= 8 
        !isPasswordValid && (errores += "- Contraseña: debe tener minimo 8 caracteres \n");
        const isPassword2Valid  = password && password2 && new RegExp("^"+ password + "$").test(password2);
        isPasswordValid && !isPassword2Valid && (errores += "- Las contraseñas no coinciden\n");
        return !isUsernameValid || !isEmailValid || !isPasswordValid || !isPassword2Valid;
      }

      window.addEventListener('load', () => {
        document.getElementById('register-form').addEventListener('submit', e => {
          e.preventDefault();
          const email = document.getElementById('email');
          const username = document.getElementById('username');
          const password = document.getElementById('password');
          const password2 = document.getElementById('password2');
          if (areErrorsPresent(email.value, username.value, password.value, password2.value)) {
            showErrors(errores);
          } else {
            register(email.value, username.value, password.value);
          }
        });

        cleanErrors();
      });

      function register(email, username, password) {
        axios.post('http://localhost:9001/api/register', { email, username, password })
          .then(() => window.location.href = 'login.html')
          .catch(({ response: { data: { error }}}) => showServerError(error));
      }

      function showServerError(error) {
        document.getElementById("server-error-message").innerText = error;
        getEmailAndPassword().forEach(addErrorClass);
        document.getElementById('server-error-message').classList.add('form__error-message-active');
      }

      function showErrors(error) {
        document.getElementById("error-message").innerText = error;
        errores = "Error: los siguientes campos son invalidos:\n"
        getEmailAndPassword().forEach(addErrorClass);
        document.getElementById('error-message').classList.add('form__error-message-active');
      }

      function cleanErrors() {
        document.getElementById('register-form').addEventListener('input', () => {
          getEmailAndPassword().forEach(removeErrorClass);
          getErrorMessages().forEach(errorMessage => {
            errorMessage.classList.remove('form__error-message-active');
          });
        });
      }

      const addErrorClass = input => input.classList.add('input__error');
      const removeErrorClass = input => input.classList.remove('input__error');
      const getEmailAndPassword = () => Object.values(document.getElementsByTagName('input'));
      const getErrorMessages = () => [document.getElementById('error-message'), document.getElementById('server-error-message')];

    </script>
</head>
<body>
<div class="login-container">

    <form action="/register" id="register-form" method="post" class="login-container__form">
        <img src="staticos/assets/images/main-logo.png" alt="" class="form__pilas-bloques-logo"/>

        <input autofocus placeholder="Ingresa tu email" id="email" name="email" type="email"/>
        <input placeholder="Ingresa tu usuario" id="username" name="username" type="text"/>
        <input placeholder="Ingresa tu contraseña" type="password" id="password" name="password"/>
        <input placeholder="Repeti tu contraseña" type="password" id="password2" name="password2"/>
        <label >Longitud minima de contraseña: 8 caracteres</label>
        <label id="error-message" class="form__error-message">Email, usuario o contraseña incorrectos</label>
        <label id="server-error-message" class="form__error-message">El email o el usuario ya se encuentra en uso</label>

        <button class="form__submit-button" id="submit">Registrarse</button>

    </form>

</div>
</body>
</html>